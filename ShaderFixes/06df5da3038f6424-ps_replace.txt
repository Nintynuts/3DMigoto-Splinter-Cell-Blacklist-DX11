// Videos on Displays - Reflections

cbuffer CB_PerCubeMapRenderCell : register(b0)
{
	float2 gCubemapScale : packoffset(c0);
}

cbuffer CB_PS_FakeGlassMaterial_Static : register(b7)
{
	bool bEnvGammaControl : packoffset(c0);
	bool bEnvPass : packoffset(c0.y);
	bool bFresnel : packoffset(c0.z);
	float4 data0 : packoffset(c1);
	float4 data1 : packoffset(c2);
	float4 data2 : packoffset(c3);
	float4 reflectionCol : packoffset(c4);
	float4 refractionCol : packoffset(c5);
	float4 edgeCol : packoffset(c6);
}

SamplerState sScreenMap_s : register(s0);
SamplerState sFingerMap_s : register(s2);
SamplerState sAltScreenMap_s : register(s3);
SamplerState sEnvMap_s : register(s9);
Texture2D<float4> sFingerMap : register(t0);
TextureCube<float4> sEnvMap : register(t1);
Texture2D<float4> sScreenMap : register(t2);
Texture2D<float4> sAltScreenMap : register(t3);

#include "3Dmigoto.hlsl"

void main(
	float4 v0 : SV_Position0,
	float4 v1 : TEXCOORD0,
	float4 v2 : TEXCOORD1,
	float4 v3 : TEXCOORD2,
	float4 v4 : TEXCOORD3,
	float3 v5 : TEXCOORD4,
	out float4 o0 : SV_Target0)
{
	float4 r0,r1,r2,r3,r4,r5;
	uint4 bitmask, uiDest;
	float4 fDest;

	r0.yzw = normalise(v4.xyz);
	r1.xyz = normalise(v3.xyz);
	r2.y = dot(r0.yzw, r1.xyz);
	r1.w = r2.y + r2.y;
	r2.y = saturate(-r2.y);
	r0.yzw = r1.xyz * -r1.w + r0.yzw;
	r3.xyz = -data1.xyz + v2.xyz;
	r3.xyz = r3.xyz / data0.y;
	r0.yzw = r3.xyz + r0.yzw;
			
	//r0.y -= separation*r0.w*convergence*0.005;

	r4 = sEnvMap.SampleLevel(sEnvMap_s, r0.yzw, 0);
	r5 = sEnvMap.SampleLevel(sEnvMap_s, r0.yzw, 3);
	r0.yzw = r5.xyz * r5.w;
	r0.yzw = r0.yzw * r0.yzw;
	r0.yzw = gCubemapScale.x * r0.yzw;
	r4.xyz = r4.xyz * r4.w;
	r4.xyz = r4.xyz * r4.xyz;
	r4.xyz = gCubemapScale.x * r4.xyz;
	r2.xz = 1 + -r2.y;
	r2.xzw = r2.xxy * r2.zzy;
	r5 = -1 + data2;
	r2 = saturate(r2 * r5 + 1);
	r4.xyz = r4.xyz * r2.w;
	r0.yzw = r0.yzw * r2.y + -r4.xyz;
	r1.w = sFingerMap.Sample(sFingerMap_s, v1.xy).y;
	r1.w = saturate(r1.w);
	r0.yzw = r1.w * r0.yzw + r4.xyz;
	r0.yzw = reflectionCol.xyz * r0.yzw;
	r0.yzw = log2(r0.yzw);
	r0.yzw = reflectionCol.w * r0.yzw;
	r0.yzw = exp2(r0.yzw);
	r4.xyz = sAltScreenMap.Sample(sAltScreenMap_s, v1.zw).xyz;
	r5.xyz = sScreenMap.Sample(sScreenMap_s, v1.xy).xyz;
	r4.xyz = -r5.xyz + r4.xyz;
	r4.xyz = data0.w * r4.xyz + r5.xyz;
	r4.xyz = r4.xyz * r4.xyz;
	r4.xyz = v5.x * r4.xyz;
	r2.xyw = r4.xyz * r2.x;
	r0.yzw = r2.xyw * data0.z + r0.yzw;
	r2.xyw = v4.xyz * r0.x + -r1.xyz;
	r2.xyw = 0.5 * r2.xyw;
	r0.x = dot(r2.xyw, -r1.xyz);
	r0.x = r0.x + r0.x;
	r1.xyz = r1.xyz * r0.x + r2.xyw;
	r1.xyz = r1.xyz + r3.xyz;
	r1 = sEnvMap.SampleLevel(sEnvMap_s, r1.xyz, data1.w);
	r1.xyz = r1.xyz * r1.w;
	r1.xyz = r1.xyz * r1.xyz;
	r1.xyz = gCubemapScale.x * r1.xyz;
	r1.xyz = v5.z * r1.xyz;
	r1.xyz = r1.xyz * r2.z;
	r1.xyz = edgeCol.xyz * r1.xyz;
	r1.xyz = log2(r1.xyz);
	r1.xyz = edgeCol.w * r1.xyz;
	r1.xyz = exp2(r1.xyz);
	o0.xyz = r1.xyz + r0.yzw;
	o0.w = 1;
	return;
}