// Videos on Displays - Reflections

cbuffer CB_PerCubeMapRenderCell : register(b0)
{
	float2 gCubemapScale : packoffset(c0);
}

cbuffer CB_PS_FakeGlassMaterial_Static : register(b7)
{
	bool bEnvGammaControl : packoffset(c0);
	bool bEnvPass : packoffset(c0.y);
	bool bFresnel : packoffset(c0.z);
	float4 data0 : packoffset(c1);
	float4 data1 : packoffset(c2);
	float4 data2 : packoffset(c3);
	float4 reflectionCol : packoffset(c4);
	float4 refractionCol : packoffset(c5);
	float4 edgeCol : packoffset(c6);
}

SamplerState sScreenMap_s : register(s0);
SamplerState sFingerMap_s : register(s2);
SamplerState sAltScreenMap_s : register(s3);
SamplerState sEnvMap_s : register(s9);
Texture2D<float4> sFingerMap : register(t0);
TextureCube<float4> sEnvMap : register(t1);
Texture2D<float4> sScreenMap : register(t2);
Texture2D<float4> sAltScreenMap : register(t3);

// 3Dmigoto declarations
#define cmp -
Texture1D<float4> IniParams : register(t120);
Texture2D<float4> StereoParams : register(t125);

void main(
	float4 v0 : SV_Position0,
	float4 v1 : TEXCOORD0,
	float4 v2 : TEXCOORD1,
	float4 v3 : TEXCOORD2,
	float4 v4 : TEXCOORD3,
	float3 v5 : TEXCOORD4,
	out float4 o0 : SV_Target0)
{
	float4 r0,r1,r2,r3,r4,r5;
	uint4 bitmask, uiDest;
	float4 fDest;

	r0.x = dot(v4.xyz, v4.xyz);
	r0.x = rsqrt(r0.x);
	r0.yzw = v4.xyz * r0.xxx;
	r1.x = dot(v3.xyz, v3.xyz);
	r1.x = rsqrt(r1.x);
	r1.xyz = v3.xyz * r1.xxx;
	r2.y = dot(r0.yzw, r1.xyz);
	r1.w = r2.y + r2.y;
	r2.y = saturate(-r2.y);
	r0.yzw = r1.xyz * -r1.www + r0.yzw;
	r3.xyz = -data1.xyz + v2.xyz;
	r3.xyz = r3.xyz / data0.yyy;
	r0.yzw = r3.xyz + r0.yzw;
			
	float4 stereo = StereoParams.Load(0);
	float4 cube_sample = r0;
	r0.y -= stereo.x*cube_sample.w*stereo.y*0.005;

	r4.xyzw = sEnvMap.SampleLevel(sEnvMap_s, r0.yzw, 0).xyzw;
	r5.xyzw = sEnvMap.SampleLevel(sEnvMap_s, r0.yzw, 3).xyzw;
	r0.yzw = r5.xyz * r5.www;
	r0.yzw = r0.yzw * r0.yzw;
	r0.yzw = gCubemapScale.xxx * r0.yzw;
	r4.xyz = r4.xyz * r4.www;
	r4.xyz = r4.xyz * r4.xyz;
	r4.xyz = gCubemapScale.xxx * r4.xyz;
	r2.xz = float2(1,1) + -r2.yy;
	r2.xzw = r2.xxy * r2.zzy;
	r5.xyzw = float4(-1,-1,-1,-1) + data2.xyzw;
	r2.xyzw = saturate(r2.xyzw * r5.xyzw + float4(1,1,1,1));
	r4.xyz = r4.xyz * r2.www;
	r0.yzw = r0.yzw * r2.yyy + -r4.xyz;
	r1.w = sFingerMap.Sample(sFingerMap_s, v1.xy).y;
	r1.w = saturate(r1.w);
	r0.yzw = r1.www * r0.yzw + r4.xyz;
	r0.yzw = reflectionCol.xyz * r0.yzw;
	r0.yzw = log2(r0.yzw);
	r0.yzw = reflectionCol.www * r0.yzw;
	r0.yzw = exp2(r0.yzw);
	r4.xyz = sAltScreenMap.Sample(sAltScreenMap_s, v1.zw).xyz;
	r5.xyz = sScreenMap.Sample(sScreenMap_s, v1.xy).xyz;
	r4.xyz = -r5.xyz + r4.xyz;
	r4.xyz = data0.www * r4.xyz + r5.xyz;
	r4.xyz = r4.xyz * r4.xyz;
	r4.xyz = v5.xxx * r4.xyz;
	r2.xyw = r4.xyz * r2.xxx;
	r0.yzw = r2.xyw * data0.zzz + r0.yzw;
	r2.xyw = v4.xyz * r0.xxx + -r1.xyz;
	r2.xyw = float3(0.5,0.5,0.5) * r2.xyw;
	r0.x = dot(r2.xyw, -r1.xyz);
	r0.x = r0.x + r0.x;
	r1.xyz = r1.xyz * r0.xxx + r2.xyw;
	r1.xyz = r1.xyz + r3.xyz;
	r1.xyzw = sEnvMap.SampleLevel(sEnvMap_s, r1.xyz, data1.w).xyzw;
	r1.xyz = r1.xyz * r1.www;
	r1.xyz = r1.xyz * r1.xyz;
	r1.xyz = gCubemapScale.xxx * r1.xyz;
	r1.xyz = v5.zzz * r1.xyz;
	r1.xyz = r1.xyz * r2.zzz;
	r1.xyz = edgeCol.xyz * r1.xyz;
	r1.xyz = log2(r1.xyz);
	r1.xyz = edgeCol.www * r1.xyz;
	r1.xyz = exp2(r1.xyz);
	o0.xyz = r1.xyz + r0.yzw;
	o0.w = 1;
	return;
}